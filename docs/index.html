import React, { useMemo, useState, useEffect, useRef } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Download, Upload, Filter, Trash2, BarChart3, PieChart, Users, BookOpen, Mail, Printer } from "lucide-react";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Pie, PieChart as RPieChart, Cell, Legend, Line, LineChart } from "recharts";

/**
 * GMI Yan Ma — Dashboard thống kê (đơn giản, tinh tế)
 *
 * Mục tiêu:
 *  - Bố cục tối giản theo "vibe" trang nhóm nghiên cứu đại học.
 *  - Thống kê công bố khoa học, thành viên, tin tức/sự kiện.
 *  - Cho phép nhập CSV để thay thế dữ liệu mẫu + lọc + xuất CSV.
 *  - Không cần backend; chạy trên GitHub Pages / static hosting.
 *
 * Thư viện dùng:
 *  - React + Tailwind (UI tổng thể)
 *  - shadcn/ui (Card, Tabs, Input, Button...)
 *  - lucide-react (biểu tượng nhẹ)
 *  - recharts (biểu đồ Bar/Pie/Line)
 *
 * Lưu ý: Toàn bộ văn bản UI ở tiếng Việt.
 */

// ===== DỮ LIỆU MẪU (có thể thay thế bằng CSV nhập vào) =====
// publications: năm, tiêu đề, tạp chí, tác giả chính, DOI/URL, chủ đề
const samplePublications = [
  { year: 2024, title: "Comparisons of two receptor-MAPK pathways in a single cell-type reveal mechanisms of signalling specificity", journal: "Nature Plants", authors: ["Ma, Y.", "Flückiger, I.", "Nicolet, J.", "et al."], url: "https://www.nature.com", topic: "Signalling" },
  { year: 2023, title: "Specificity models in MAPK cascade signaling", journal: "FEBS Open Bio", authors: ["Ma, Y.", "Nicolet, J."], url: "https://febs.onlinelibrary.wiley.com", topic: "Signalling" },
  { year: 2018, title: "Distinct modes of derepression of an Arabidopsis immune receptor complex by two different bacterial effectors", journal: "PNAS", authors: ["Ma, Y.", "Guo, H.", "Hu, L.", "et al."], url: "https://www.pnas.org", topic: "Immunity" },
  { year: 2015, title: "A Plant Immune Receptor Detects Pathogen Effectors that Target WRKY Transcription Factors", journal: "Cell", authors: ["Sarris, P.F.", "Duxbury, Z.", "Huh, S.U.", "Ma, Y.", "et al."], url: "https://www.sciencedirect.com", topic: "Immunity" },
];

// members: tên, vai trò
const sampleMembers = [
  { name: "Yan Ma", role: "Nhóm trưởng" },
  { name: "Hing Pan Ng", role: "Nghiên cứu sinh Tiến sĩ" },
  { name: "Zeynep Begüm Sen", role: "Nghiên cứu sinh Tiến sĩ" },
  { name: "Marina Silvestre Vano", role: "Trợ lý nghiên cứu cao cấp" },
];

// news/events (ngày ISO, tiêu đề)
const sampleNews = [
  { date: "2025-07-10", title: "DOC Fellowship cho Hing Pan Ng" },
  { date: "2025-04-01", title: "Bắt đầu nhóm nghiên cứu tại GMI" },
  { date: "2024-05-08", title: "Làm quen Yan Ma, Trưởng nhóm mới tại GMI" },
];

// ===== TIỆN ÍCH CSV =====
function downloadCSV(filename, rows) {
  const csv = [Object.keys(rows[0]).join(",")]
    .concat(rows.map(r => Object.values(r).map(v => typeof v === "string" ? '"' + v.replace(/"/g, '""') + '"' : v).join(",")))
    .join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function parseCSV(text) {
  // Parser đơn giản: tách theo dòng và dấu phẩy (không xử lý mọi edge-case)
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(",").map(h => h.trim());
  return lines.map(line => {
    const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g, ""));
    const obj = {}; headers.forEach((h, i) => obj[h] = cols[i]);
    // ép kiểu số/năm nếu có
    if (obj.year) obj.year = Number(obj.year);
    return obj;
  });
}

// ===== THÀNH PHẦN PHỤ =====
function StatCard({ icon: Icon, label, value, sub }: { icon: any; label: string; value: string | number; sub?: string }) {
  return (
    <Card className="shadow-sm">
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium text-muted-foreground">{label}</CardTitle>
        <Icon className="h-4 w-4 text-muted-foreground" />
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-semibold">{value}</div>
        {sub && <p className="text-xs text-muted-foreground mt-1">{sub}</p>}
      </CardContent>
    </Card>
  );
}

function Section({ title, children, right }: { title: string; children: React.ReactNode; right?: React.ReactNode }) {
  return (
    <section className="space-y-3">
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold tracking-tight">{title}</h2>
        {right}
      </div>
      <div className="grid gap-4">{children}</div>
    </section>
  );
}

// ===== ỨNG DỤNG CHÍNH =====
export default function DashboardGMI() {
  // state dữ liệu (cho phép thay thế bằng CSV)
  const [publications, setPublications] = useState(samplePublications);
  const [members, setMembers] = useState(sampleMembers);
  const [news, setNews] = useState(sampleNews);

  // lọc & tìm kiếm
  const [yearFilter, setYearFilter] = useState("all");
  const [topicFilter, setTopicFilter] = useState("all");
  const [search, setSearch] = useState("");

  const filteredPubs = useMemo(() => {
    return publications.filter(p =>
      (yearFilter === "all" || String(p.year) === String(yearFilter)) &&
      (topicFilter === "all" || p.topic?.toLowerCase() === topicFilter.toLowerCase()) &&
      (search === "" || [p.title, p.journal, ...(p.authors||[])].join(" ").toLowerCase().includes(search.toLowerCase()))
    );
  }, [publications, yearFilter, topicFilter, search]);

  // số liệu tổng quan
  const stats = useMemo(() => {
    const thisYear = new Date().getFullYear();
    const pubsThisYear = publications.filter(p => p.year === thisYear).length;
    const topics = Array.from(new Set(publications.map(p => p.topic))).filter(Boolean);
    return {
      totalPubs: publications.length,
      pubsThisYear,
      members: members.length,
      topics: topics.length,
    };
  }, [publications, members]);

  // dữ liệu biểu đồ: công bố theo năm
  const pubsByYear = useMemo(() => {
    const map = new Map();
    publications.forEach(p => map.set(p.year, (map.get(p.year) || 0) + 1));
    return Array.from(map.entries()).sort((a,b)=>a[0]-b[0]).map(([year, count]) => ({ year, count }));
  }, [publications]);

  // dữ liệu biểu đồ: phân bổ chủ đề
  const topicPie = useMemo(() => {
    const map = new Map();
    publications.forEach(p => map.set(p.topic || "Khác", (map.get(p.topic || "Khác") || 0) + 1));
    return Array.from(map.entries()).map(([name, value]) => ({ name, value }));
  }, [publications]);

  // tải CSV vào
  const fileInputRef = useRef(null as HTMLInputElement | null);
  function handleUploadCSV(kind: "pubs" | "members" | "news") {
    fileInputRef.current?.click();
    const onChange = async (e: any) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      const rows = parseCSV(text);
      if (kind === "pubs") setPublications(rows as any);
      if (kind === "members") setMembers(rows as any);
      if (kind === "news") setNews(rows as any);
      e.target.value = ""; // reset
      fileInputRef.current?.removeEventListener("change", onChange);
    };
    fileInputRef.current?.addEventListener("change", onChange);
  }

  // xuất CSV
  function exportCurrentPubs() {
    if (!filteredPubs.length) return;
    downloadCSV("publications.csv", filteredPubs);
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 text-slate-100">
      <header className="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-slate-950/70 border-b border-slate-800">
        <div className="container mx-auto px-4 py-3 flex items-center justify-between">
          <div className="font-semibold tracking-tight">GMI — Nhóm Yan Ma · Thống kê</div>
          <nav className="flex items-center gap-2">
            <Button variant="ghost" className="gap-2"><BarChart3 className="h-4 w-4"/>Tổng quan</Button>
            <Button variant="ghost" className="gap-2"><BookOpen className="h-4 w-4"/>Công bố</Button>
            <Button variant="ghost" className="gap-2"><Users className="h-4 w-4"/>Thành viên</Button>
            <Button asChild className="gap-2">
              <a href="#lien-he"><Mail className="h-4 w-4"/>Liên hệ</a>
            </Button>
          </nav>
        </div>
      </header>

      <main className="container mx-auto px-4 py-6 space-y-8">
        {/* KHỐI THÔNG SỐ TỔNG QUAN */}
        <Section title="Tổng quan">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <StatCard icon={BookOpen} label="Tổng công bố" value={stats.totalPubs} sub="Tất cả năm" />
            <StatCard icon={BarChart3} label="Công bố năm nay" value={stats.pubsThisYear} />
            <StatCard icon={Users} label="Số thành viên" value={stats.members} />
            <StatCard icon={PieChart} label="Số chủ đề" value={stats.topics} />
          </div>
        </Section>

        {/* BIỂU ĐỒ */}
        <Section title="Biểu đồ công bố">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle className="text-base">Số công bố theo năm</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={pubsByYear}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                      <XAxis dataKey="year" stroke="#cbd5e1" />
                      <YAxis allowDecimals={false} stroke="#cbd5e1" />
                      <Tooltip contentStyle={{ background: "#0f172a", border: "1px solid #334155" }} />
                      <Bar dataKey="count" fill="#86a8ff" radius={[6,6,0,0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="text-base">Phân bổ chủ đề</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <RPieChart>
                      <Pie data={topicPie} dataKey="value" nameKey="name" innerRadius={50} outerRadius={80}>
                        {topicPie.map((_, i) => (
                          <Cell key={i} fill={["#86a8ff", "#9bffd6", "#fbbf24", "#f472b6", "#34d399"][i % 5]} />
                        ))}
                      </Pie>
                      <Tooltip contentStyle={{ background: "#0f172a", border: "1px solid #334155" }} />
                      <Legend />
                    </RPieChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
        </Section>

        {/* CÔNG BỐ KHOA HỌC */}
        <Section
          title="Công bố khoa học"
          right={
            <div className="flex items-center gap-2">
              <div className="hidden sm:flex items-center gap-2">
                <Label htmlFor="year">Năm</Label>
                <select id="year" className="bg-slate-900 border border-slate-700 rounded px-2 py-1" value={yearFilter} onChange={e=>setYearFilter(e.target.value)}>
                  <option value="all">Tất cả</option>
                  {[...new Set(publications.map(p=>p.year))].sort((a,b)=>a-b).map(y => <option key={y} value={String(y)}>{y}</option>)}
                </select>
                <Label htmlFor="topic">Chủ đề</Label>
                <select id="topic" className="bg-slate-900 border border-slate-700 rounded px-2 py-1" value={topicFilter} onChange={e=>setTopicFilter(e.target.value)}>
                  <option value="all">Tất cả</option>
                  {[...new Set(publications.map(p=>p.topic).filter(Boolean))].map(t => <option key={t} value={String(t)}>{t}</option>)}
                </select>
              </div>
              <div className="flex items-center gap-2">
                <Input placeholder="Tìm tiêu đề/tác giả..." value={search} onChange={e=>setSearch(e.target.value)} className="w-40 sm:w-60" />
                <Button variant="outline" className="gap-2" onClick={exportCurrentPubs}><Download className="h-4 w-4"/>CSV</Button>
                <Button variant="outline" className="gap-2" onClick={()=>handleUploadCSV("pubs")}><Upload className="h-4 w-4"/>Nhập CSV</Button>
                <input ref={fileInputRef} type="file" accept=".csv" className="hidden" />
              </div>
            </div>
          }
        >
          <Card>
            <CardContent className="p-0">
              <div className="divide-y divide-slate-800">
                {filteredPubs.map((p, idx) => (
                  <div key={idx} className="p-4 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
                    <div>
                      <div className="font-medium">{p.title}</div>
                      <div className="text-sm text-slate-400">{p.journal} · {p.year}</div>
                      <div className="text-sm text-slate-400">Tác giả: {(p.authors || []).join(", ")}</div>
                      <div className="mt-2 flex flex-wrap gap-2 items-center">
                        {p.topic && <Badge variant="secondary" className="bg-slate-800">{p.topic}</Badge>}
                        {p.url && <a href={p.url} className="text-sky-300 hover:underline" target="_blank" rel="noreferrer">Liên kết</a>}
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Button variant="ghost" size="icon" onClick={()=>window.open(p.url, "_blank")} aria-label="Mở liên kết">
                        <BookOpen className="h-4 w-4"/>
                      </Button>
                    </div>
                  </div>
                ))}
                {filteredPubs.length === 0 && (
                  <div className="p-6 text-sm text-slate-400">Không có mục nào phù hợp bộ lọc.</div>
                )}
              </div>
            </CardContent>
          </Card>
        </Section>

        {/* THÀNH VIÊN */}
        <Section title="Thành viên">
          <Card>
            <CardContent className="p-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {members.map((m, i) => (
                  <div key={i} className="rounded-xl border border-slate-800 p-4 bg-slate-900/40">
                    <div className="font-medium">{m.name}</div>
                    <div className="text-sm text-slate-400">{m.role}</div>
                  </div>
                ))}
              </div>
              <div className="mt-4 flex gap-2">
                <Button variant="outline" className="gap-2" onClick={()=>handleUploadCSV("members")}><Upload className="h-4 w-4"/>Nhập CSV thành viên</Button>
                <Button variant="outline" className="gap-2" onClick={()=>downloadCSV("members.csv", members)}><Download className="h-4 w-4"/>CSV</Button>
              </div>
            </CardContent>
          </Card>
        </Section>

        {/* TIN TỨC / SỰ KIỆN */}
        <Section title="Tin tức & Sự kiện">
          <Card>
            <CardContent className="p-0">
              <div className="divide-y divide-slate-800">
                {news.map((n, i) => (
                  <div key={i} className="p-4 flex items-center justify-between">
                    <div>
                      <div className="text-sm text-slate-400">{new Date(n.date).toLocaleDateString()}</div>
                      <div className="font-medium">{n.title}</div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="p-4 flex gap-2">
                <Button variant="outline" className="gap-2" onClick={()=>handleUploadCSV("news")}><Upload className="h-4 w-4"/>Nhập CSV tin tức</Button>
                <Button variant="outline" className="gap-2" onClick={()=>downloadCSV("news.csv", news)}><Download className="h-4 w-4"/>CSV</Button>
              </div>
            </CardContent>
          </Card>
        </Section>

        {/* IN/EXPORT TOÀN TRANG */}
        <div className="flex flex-wrap gap-2">
          <Button variant="outline" className="gap-2" onClick={()=>window.print()}><Printer className="h-4 w-4"/>In báo cáo</Button>
        </div>

        {/* LIÊN HỆ */}
        <Section title="Liên hệ">
          <Card id="lien-he">
            <CardContent className="p-4 space-y-3">
              <p className="text-sm text-slate-300">Gregor Mendel Institute of Molecular Plant Biology, Austrian Academy of Sciences</p>
              <p className="text-sm text-slate-400">Dr. Bohr-Gasse 3, 1030 Vienna, Austria · T: +43 1 79044-9000</p>
              <a className="text-sky-300 hover:underline" href="mailto:office@gmi.oeaw.ac.at">office@gmi.oeaw.ac.at</a>
            </CardContent>
          </Card>
        </Section>

        <Separator className="my-8" />
        <p className="text-xs text-slate-500">© {new Date().getFullYear()} Bảng điều khiển thống kê (demo). Dữ liệu có thể nhập qua CSV, không lưu máy chủ.</p>
      </main>
    </div>
  );
}
